<UserControl x:Class="WPFGrowerApp.Views.PaymentBatchListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:WPFGrowerApp.Views"
             xmlns:vm="clr-namespace:WPFGrowerApp.ViewModels"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converters="clr-namespace:WPFGrowerApp.Converters"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=vm:PaymentBatchViewModel}"
             d:DesignHeight="600" d:DesignWidth="1000"
             Background="{DynamicResource MaterialDesignPaper}"
             Focusable="True">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/StandardizedViewTemplate.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <converters:BoolToVisibilityConverter x:Key="BoolToVisConverter"/>
            <converters:StatusToVisibilityConverter x:Key="StatusToVisibilityConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Breadcrumb -->
            <RowDefinition Height="Auto"/>  <!-- Title -->
            <RowDefinition Height="Auto"/>  <!-- Search/Filter Bar -->
            <RowDefinition Height="Auto"/>  <!-- Statistics -->
            <RowDefinition Height="*"/>     <!-- Main Content (DataGrid) -->
            <RowDefinition Height="Auto"/>  <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Breadcrumb Navigation -->
        <materialDesign:ColorZone Grid.Row="0" Style="{StaticResource BreadcrumbNavigationStyle}">
            <StackPanel Orientation="Horizontal">
                <Button Style="{StaticResource MaterialDesignFlatButton}"
                        Padding="5,0"
                        Command="{Binding NavigateToDashboardCommand}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Home" Width="16" Height="16" 
                                               VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBlock Text="Dashboard" FontSize="12"/>
                    </StackPanel>
                </Button>
                <materialDesign:PackIcon Kind="ChevronRight" Width="16" Height="16" 
                                       VerticalAlignment="Center" Margin="5,0"/>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="CashMultiple" Width="16" Height="16" 
                                           VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="Payment Batches" FontSize="12" FontWeight="SemiBold"/>
                </StackPanel>
            </StackPanel>
        </materialDesign:ColorZone>

        <!-- Title -->
        <TextBlock Grid.Row="1" 
                   Text="Payment Batches" 
                   Style="{StaticResource StandardizedViewTitleStyle}"/>

        <!-- Search/Filter Bar -->
        <materialDesign:Card Grid.Row="2" Margin="0,0,0,10">
            <Grid Margin="15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>      <!-- Search -->
                    <ColumnDefinition Width="Auto"/>   <!-- Year Filter -->
                    <ColumnDefinition Width="Auto"/>   <!-- Status Filter -->
                    <ColumnDefinition Width="Auto"/>   <!-- Type Filter -->
                    <ColumnDefinition Width="Auto"/>   <!-- Clear -->
                    <ColumnDefinition Width="Auto"/>   <!-- Refresh -->
                </Grid.ColumnDefinitions>

                <!-- Search TextBox -->
                <TextBox Grid.Column="0"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         materialDesign:HintAssist.Hint="Search batches by number..."
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         VerticalAlignment="Center"
                         Margin="0,0,10,0"/>

                <!-- Crop Year Filter -->
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding CropYears}"
                          SelectedItem="{Binding FilterCropYear}"
                          materialDesign:HintAssist.Hint="Crop Year"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          Width="120"
                          Margin="0,0,10,0"/>

                <!-- Status Filter -->
                <ComboBox Grid.Column="2"
                          ItemsSource="{Binding StatusOptions}"
                          SelectedItem="{Binding FilterStatus}"
                          materialDesign:HintAssist.Hint="Status"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          Width="120"
                          Margin="0,0,10,0"/>

                <!-- Payment Type Filter -->
                <ComboBox Grid.Column="3"
                          ItemsSource="{Binding PaymentTypes}"
                          SelectedValue="{Binding FilterPaymentType}"
                          SelectedValuePath="PaymentTypeId"
                          DisplayMemberPath="TypeName"
                          materialDesign:HintAssist.Hint="Payment Type"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          Width="150"
                          Margin="0,0,10,0"/>

                <!-- Clear Filters Button -->
                <Button Grid.Column="4"
                        Command="{Binding ClearFiltersCommand}"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Width="90"
                        Margin="0,0,5,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FilterRemove" Width="16" Height="16" Margin="0,0,5,0"/>
                        <TextBlock Text="Clear"/>
                    </StackPanel>
                </Button>

                <!-- Refresh Button -->
                <Button Grid.Column="5"
                        Command="{Binding RefreshCommand}"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Refresh (F5)"
                        Width="40">
                    <materialDesign:PackIcon Kind="Refresh" Width="20" Height="20"/>
                </Button>
            </Grid>
        </materialDesign:Card>

        <!-- Statistics Card -->
        <materialDesign:Card Grid.Row="3" Margin="0,0,0,10"
                             Background="{DynamicResource PrimaryHueLightBrush}">
            <Grid Margin="15">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="FolderMultiple" 
                                           Width="20" Height="20" 
                                           VerticalAlignment="Center" 
                                           Margin="0,0,8,0"
                                           Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                    <TextBlock Text="{Binding PaymentBatches.Count, StringFormat='{}{0} Batches'}" 
                              FontWeight="SemiBold"
                              VerticalAlignment="Center"
                              Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Main Content - Batch List -->
        <materialDesign:Card Grid.Row="4" Style="{StaticResource MainContentAreaStyle}">
            <DataGrid x:Name="BatchesDataGrid"
                      ItemsSource="{Binding PaymentBatches}"
                      SelectedItem="{Binding SelectedBatch}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      CanUserAddRows="False"
                      SelectionMode="Single"
                      MouseDoubleClick="BatchesDataGrid_MouseDoubleClick"
                      materialDesign:DataGridAssist.CellPadding="13 8 8 8"
                      materialDesign:DataGridAssist.ColumnHeaderPadding="13 10 8 10"
                      EnableRowVirtualization="True"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      ScrollViewer.CanContentScroll="True"
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto">

                <DataGrid.Columns>
                    <!-- Batch Number -->
                    <DataGridTextColumn Header="Batch Number" Binding="{Binding BatchNumber}" Width="140">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="FontSize" Value="13"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Payment Type -->
                    <DataGridTextColumn Header="Payment Type" Binding="{Binding PaymentTypeName}" Width="130"/>

                    <!-- Batch Date -->
                    <DataGridTextColumn Header="Batch Date" 
                                        Binding="{Binding BatchDate, StringFormat='{}{0:MMM dd, yyyy}'}" 
                                        Width="120"/>

                    <!-- Crop Year -->
                    <DataGridTextColumn Header="Year" Binding="{Binding CropYear}" Width="70"/>

                    <!-- Status -->
                    <DataGridTemplateColumn Header="Status" Width="100" SortMemberPath="Status">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="10"
                                        Padding="8,4"
                                        Height="24"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#4CAF50"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="Draft">
                                                    <Setter Property="Background" Value="#FFC107"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Voided">
                                                    <Setter Property="Background" Value="#F44336"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding Status}"
                                               Foreground="White"
                                               FontWeight="SemiBold"
                                               FontSize="11"
                                               VerticalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Growers -->
                    <DataGridTextColumn Header="Growers" Binding="{Binding TotalGrowers}" Width="80"/>

                    <!-- Total Amount -->
                    <DataGridTextColumn Header="Amount" 
                                        Binding="{Binding TotalAmount, StringFormat='${0:N2}'}" 
                                        Width="120">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Created Date -->
                    <DataGridTextColumn Header="Created" 
                                        Binding="{Binding CreatedAt, StringFormat='{}{0:MMM dd, yyyy}'}" 
                                        Width="120"/>

                    <!-- Created By -->
                    <DataGridTextColumn Header="Created By" Binding="{Binding CreatedBy}" Width="100"/>

                    <!-- Actions -->
                    <DataGridTemplateColumn Header="Actions" Width="240">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.ViewBatchCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="View Details"
                                            Width="30" Height="30">
                                        <materialDesign:PackIcon Kind="Eye" Width="16" Height="16"/>
                                    </Button>
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.ApproveBatchCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Approve Batch"
                                            Width="30" Height="30"
                                            Foreground="Green"
                                            Visibility="{Binding Status, Converter={StaticResource StatusToVisibilityConverter}, ConverterParameter='Draft'}">
                                        <materialDesign:PackIcon Kind="CheckCircle" Width="16" Height="16"/>
                                    </Button>
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.PostBatchCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Post Batch (Create payment allocations)"
                                            Width="30" Height="30"
                                            Foreground="Orange"
                                            Visibility="{Binding Status, Converter={StaticResource StatusToVisibilityConverter}, ConverterParameter='Approved'}">
                                        <materialDesign:PackIcon Kind="Post" Width="16" Height="16"/>
                                    </Button>
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.ProcessPaymentsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Process Payments"
                                            Width="30" Height="30"
                                            Foreground="Blue"
                                            Visibility="{Binding Status, Converter={StaticResource StatusToVisibilityConverter}, ConverterParameter='Posted'}">
                                        <materialDesign:PackIcon Kind="CashMultiple" Width="16" Height="16"/>
                                    </Button>
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.VoidBatchCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Void Batch (Cancel batch, allocations, and cheques)"
                                            Width="30" Height="30"
                                            Foreground="IndianRed">
                                        <materialDesign:PackIcon Kind="Cancel" Width="16" Height="16"/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </materialDesign:Card>

        <!-- Status Bar -->
        <materialDesign:ColorZone Grid.Row="5" Style="{StaticResource StatusFooterBarStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Total Batches: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding PaymentBatches.Count}"/>
                </StackPanel>

                <TextBlock Grid.Column="2"
                           Text="Click the eye icon to view batch details"
                           FontStyle="Italic"
                           Opacity="0.7"/>
            </Grid>
        </materialDesign:ColorZone>

        <!-- Loading Indicator -->
        <materialDesign:Card Grid.Row="0" 
                            Grid.RowSpan="6"
                            Style="{StaticResource LoadingIndicatorStyle}"
                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}">
            <StackPanel Orientation="Horizontal">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                            Value="0"
                            IsIndeterminate="True"/>
                <TextBlock Text="Loading payment batches..."
                          VerticalAlignment="Center"
                          Margin="10,0,0,0"/>
            </StackPanel>
        </materialDesign:Card>
    </Grid>
</UserControl>


