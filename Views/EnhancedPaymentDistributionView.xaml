<UserControl x:Class="WPFGrowerApp.Views.EnhancedPaymentDistributionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converters="clr-namespace:WPFGrowerApp.Converters"
             Focusable="True"
             KeyDown="Window_KeyDown">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/StandardizedViewTemplate.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
            <converters:BoolToBrushConverter x:Key="BoolToBrushConverter"/>
            <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Breadcrumb -->
            <RowDefinition Height="Auto"/> <!-- Title -->
            <RowDefinition Height="Auto"/> <!-- Search Bar -->
            <RowDefinition Height="Auto"/> <!-- Statistics -->
            <RowDefinition Height="*"/>     <!-- Main Content -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="6" 
              Background="#80000000" 
              Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
              Panel.ZIndex="1000">
            <Border HorizontalAlignment="Center" 
                    VerticalAlignment="Center"
                    Background="{DynamicResource ThemeCardBackground}"
                    CornerRadius="8"
                    Padding="24">
                <StackPanel>
                <ProgressBar IsIndeterminate="True" 
                             Width="40" 
                             Height="40"
                             Margin="0,0,0,16"
                             Style="{DynamicResource MaterialDesignCircularProgressBar}"/>
                <TextBlock Text="Loading payment data..." 
                          Style="{DynamicResource MaterialDesignBody1TextBlock}"
                          HorizontalAlignment="Center"
                          Foreground="{DynamicResource MaterialDesignBody}"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Breadcrumb Navigation -->
        <materialDesign:ColorZone Grid.Row="0" Style="{StaticResource BreadcrumbNavigationStyle}">
            <StackPanel Orientation="Horizontal">
                <Button Style="{StaticResource MaterialDesignFlatButton}"
                        Command="{Binding NavigateToDashboardCommand}"
                        Padding="5,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Home" Width="16" Height="16" 
                                               VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBlock Text="Dashboard" FontSize="12"/>
                    </StackPanel>
                </Button>
                <materialDesign:PackIcon Kind="ChevronRight" Width="16" Height="16" 
                                        VerticalAlignment="Center" Margin="5,0"/>
                <Button Style="{StaticResource MaterialDesignFlatButton}"
                        Command="{Binding NavigateToPaymentManagementCommand}"
                        Padding="5,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="CreditCard" Width="16" Height="16" 
                                               VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBlock Text="Payment Management" FontSize="12"/>
                    </StackPanel>
                </Button>
                <materialDesign:PackIcon Kind="ChevronRight" Width="16" Height="16" 
                                        VerticalAlignment="Center" Margin="5,0"/>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="Share" Width="16" Height="16" 
                                           VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="Enhanced Payment Distribution" FontSize="12" FontWeight="SemiBold"/>
                </StackPanel>
            </StackPanel>
        </materialDesign:ColorZone>

        <!-- View Title -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="16,8">
            <materialDesign:PackIcon Kind="AccountMultiple" Width="24" Height="24" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBlock Text="Enhanced Payment Distribution" Style="{DynamicResource MaterialDesignHeadline4TextBlock}" VerticalAlignment="Center"/>
        </StackPanel>

        <!-- Search and Filter Bar -->
        <materialDesign:Card Grid.Row="2" Margin="0,0,0,10">
            <Grid Margin="15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0"
                       Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                       materialDesign:HintAssist.Hint="Search growers or batches..."
                       Style="{StaticResource MaterialDesignOutlinedTextBox}"
                       VerticalAlignment="Center">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding SearchCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="10,0,0,0">
                    <ComboBox SelectedItem="{Binding SelectedPaymentMethod}"
                              ItemsSource="{Binding PaymentMethods}"
                              materialDesign:HintAssist.Hint="Payment Method"
                              Style="{StaticResource MaterialDesignOutlinedComboBox}"
                              Width="140" Margin="0,0,10,0"/>
                    
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Command="{Binding RefreshCommand}"
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="Refresh data (F5)"
                            Width="40" Margin="0,0,5,0">
                        <materialDesign:PackIcon Kind="Refresh" Width="20" Height="20"/>
                    </Button>
                    
                    <Button Command="{Binding ClearFiltersCommand}"
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="Clear all filters"
                            Width="40" Margin="0,0,5,0">
                        <materialDesign:PackIcon Kind="FilterRemove" Width="20" Height="20"/>
                    </Button>
                    
                    <Button Command="{Binding ShowHelpCommand}"
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="Show help (F1)"
                            Width="40">
                        <materialDesign:PackIcon Kind="HelpCircle" 
                                               Width="20" Height="20"
                                               Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Payment Statistics - User Management Style -->
        <materialDesign:Card Grid.Row="3" Margin="0,0,0,10" Background="{DynamicResource PrimaryHueLightBrush}">
            <Grid Margin="15">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Package" 
                                           Width="20" Height="20" 
                                           VerticalAlignment="Center" 
                                           Margin="0,0,8,0"
                                           Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                    <TextBlock Text="{Binding TotalBatches, StringFormat='{}{0} Batches'}" 
                              FontWeight="SemiBold"
                              VerticalAlignment="Center"
                              Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"
                              Margin="0,0,20,0"/>
                    
                    <materialDesign:PackIcon Kind="AccountGroup" 
                                           Width="20" Height="20" 
                                           VerticalAlignment="Center" 
                                           Margin="0,0,8,0"
                                           Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                    <TextBlock Text="{Binding TotalGrowers, StringFormat='{}{0} Growers'}" 
                              FontWeight="SemiBold"
                              VerticalAlignment="Center"
                              Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"
                              Margin="0,0,20,0"/>
                    
                    <materialDesign:PackIcon Kind="CurrencyUsd" 
                                           Width="20" Height="20" 
                                           VerticalAlignment="Center" 
                                           Margin="0,0,8,0"
                                           Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                    <TextBlock Text="{Binding TotalAmountDisplay}" 
                              FontWeight="SemiBold"
                              VerticalAlignment="Center"
                              Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"
                              Margin="0,0,20,0"/>
                    
                    <materialDesign:PackIcon Kind="Merge" 
                                           Width="20" Height="20" 
                                           VerticalAlignment="Center" 
                                           Margin="0,0,8,0"
                                           Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                    <TextBlock Text="{Binding ConsolidationOpportunitiesDisplay}" 
                              FontWeight="SemiBold"
                              VerticalAlignment="Center"
                              Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Main Content -->
        <Grid Grid.Row="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Batch Selection and Payment Method -->
            <materialDesign:Card Grid.Column="0" Style="{StaticResource MainContentAreaStyle}" Margin="0,0,5,0">
                <StackPanel Margin="15">
                    <TextBlock Text="Payment Method Selection" 
                               Style="{DynamicResource MaterialDesignHeadline6TextBlock}" 
                               Margin="0,0,0,16"/>
                    
                    <!-- Batch Selection -->
                    <TextBlock Text="Available Batches" 
                               Style="{DynamicResource MaterialDesignSubtitle2TextBlock}" 
                               Margin="0,0,0,8"/>
                    
                    <!-- Select All Checkbox -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <CheckBox IsChecked="{Binding SelectAllBatches}" 
                                  Margin="0,0,8,0"
                                  VerticalAlignment="Center"/>
                        <TextBlock Text="Select All" 
                                   Style="{DynamicResource MaterialDesignBody2TextBlock}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <ListBox ItemsSource="{Binding AvailableBatches}"
                             SelectionMode="Multiple"
                             Height="350"
                             Margin="0,0,0,12"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             ScrollViewer.CanContentScroll="True"
                             materialDesign:ListBoxItemAssist.ShowSelection="True">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="4">
                                    <CheckBox IsChecked="{Binding IsSelected}" 
                                              Margin="0,0,8,0"
                                              VerticalAlignment="Center"/>
                                    <StackPanel>
                                        <TextBlock Text="{Binding BatchNumber}" 
                                                   FontWeight="SemiBold"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding BatchDate, StringFormat='MMM dd, yyyy'}" 
                                                   FontSize="11"
                                                   Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    
                </StackPanel>
            </materialDesign:Card>
            
            <!-- Grower Selections and Consolidation -->
            <materialDesign:Card Grid.Column="1" Style="{StaticResource MainContentAreaStyle}" Margin="5,0,0,0">
                <Grid Margin="15">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- List Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16">
                        <TextBlock Text="Grower Payment Selections" 
                                   Style="{DynamicResource MaterialDesignHeadline6TextBlock}" 
                                   VerticalAlignment="Center"/>
                        
                        <Button Content="Preview Distribution" 
                                Command="{Binding PreviewDistributionCommand}"
                                Style="{DynamicResource MaterialDesignOutlinedButton}"
                                Margin="16,0,0,0"
                                Padding="12,6"/>
                        
                        <!-- Export Menu Button -->
                        <StackPanel Orientation="Horizontal" Margin="8,0,0,0">
                            <ToggleButton x:Name="ExportMenuToggle"
                                         Style="{DynamicResource MaterialDesignOutlinedButton}"
                                         Padding="12,6">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Export"/>
                                    <materialDesign:PackIcon Kind="ChevronDown" Width="26" Height="16" 
                                                             Margin="8,0,0,0"/>
                                </StackPanel>
                            </ToggleButton>
                            
                            <Popup IsOpen="{Binding IsChecked, ElementName=ExportMenuToggle}"
                                   PlacementTarget="{Binding ElementName=ExportMenuToggle}"
                                   Placement="Bottom"
                                   StaysOpen="False"
                                   AllowsTransparency="True">
                                <materialDesign:Card Padding="0">
                                    <Border BorderBrush="{DynamicResource ThemeCardBorder}"
                                            BorderThickness="1"
                                            Background="{DynamicResource ThemeCardBackground}">
                                        <StackPanel>
                                            <Button Command="{Binding ExportToExcelCommand}"
                                                    Style="{DynamicResource MaterialDesignFlatButton}"
                                                    HorizontalContentAlignment="Left"
                                                    Padding="2,2"
                                                    MinWidth="100"
                                                    Click="ClosePopup">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="FileExcel" Width="20" Height="20" Margin="0,0,2,0"/>
                                                    <TextBlock Text="Excel (.xlsx)" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Button>
                                            
                                            <Separator/>
                                            
                                            <Button Command="{Binding ExportToPdfCommand}"
                                                    Style="{DynamicResource MaterialDesignFlatButton}"
                                                    HorizontalContentAlignment="Left"
                                                    Padding="2,2"
                                                    MinWidth="100"
                                                    Click="ClosePopup">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="FilePdfBox" Width="20" Height="20" Margin="0,0,2,0"/>
                                                    <TextBlock Text="PDF (.pdf)" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>
                                    </Border>
                                </materialDesign:Card>
                            </Popup>
                        </StackPanel>
                        
                        <Button Content="Generate Selected Payments" 
                                Command="{Binding GenerateSelectedPaymentsCommand}"
                                Style="{DynamicResource MaterialDesignRaisedButton}"
                                Margin="8,0,0,0"
                                Padding="12,6"/>
                    </StackPanel>
                    
                    <!-- DataGrid -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding GrowerSelections}"
                              SelectedItem="{Binding SelectedGrowerSelection}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeColumns="True"
                              CanUserSortColumns="True"
                              CanUserReorderColumns="False"
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              SelectionMode="Single"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              ScrollViewer.CanContentScroll="True"
                              materialDesign:DataGridAssist.CellPadding="8 6 8 6"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="8 8 8 8"
                              AlternatingRowBackground="{DynamicResource MaterialDesignDataGridRowHoverBackground}"
                              RowHeaderWidth="0">
                        
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasExcessiveAdvances}" Value="True">
                                        <Setter Property="Background" Value="#FFF3E0"/>
                                        <Setter Property="BorderBrush" Value="#FF9800"/>
                                        <Setter Property="BorderThickness" Value="0,0,0,2"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        
                        <DataGrid.Columns>
                            <!-- Selection Checkbox -->
                            <DataGridTemplateColumn Header="" Width="40">
                                <DataGridTemplateColumn.HeaderTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding DataContext.SelectAllGrowers, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                  ToolTip="Select/Deselect All"
                                                  HorizontalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.HeaderTemplate>
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding IsSelectedForPayment, UpdateSourceTrigger=PropertyChanged}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <!-- Grower -->
                            <DataGridTextColumn Header="Grower" 
                                                Binding="{Binding GrowerDisplay}" 
                                                Width="200"
                                                CanUserSort="True"/>
                             <!-- Gross/Total Amount -->
                            <DataGridTextColumn Header="Gross Amount" 
                                                Binding="{Binding GrossTotalAmountDisplay}" 
                                                Width="140"
                                                CanUserSort="True"/>

                            <!-- Net Amount (Always Consolidated) -->
                            <DataGridTextColumn Header="Net Amount" 
                                                Binding="{Binding NetConsolidatedAmountDisplay, UpdateSourceTrigger=PropertyChanged}" 
                                                Width="120"
                                                CanUserSort="True"/>
                            
                            <!-- Outstanding Advances -->
                            <DataGridTextColumn Header="Outstanding" 
                                                Binding="{Binding OutstandingAdvancesDisplay}" 
                                                Width="100"
                                                CanUserSort="True"/>
                            
                            <!-- Deduct From This Transaction -->
                            <DataGridTemplateColumn Header="Deduct From This Transaction" Width="180">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding DeductFromThisTransaction, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                 IsEnabled="{Binding HasOutstandingAdvances}"
                                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                                 Margin="2"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <!-- Remaining Deductions -->
                            <DataGridTextColumn Header="Remaining Deductions" 
                                                Binding="{Binding RemainingDeductionsDisplay, UpdateSourceTrigger=PropertyChanged}" 
                                                Width="140"
                                                CanUserSort="True"/>
                                                                                 
                            <!-- Status -->
                            <DataGridTextColumn Header="Status" 
                                                Binding="{Binding StatusDisplay, UpdateSourceTrigger=PropertyChanged}" 
                                                Width="120"
                                                CanUserSort="True"/>
                            
                            <!-- Actions -->
                            <DataGridTemplateColumn Header="Actions" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Command="{Binding DataContext.PreviewCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    Style="{DynamicResource MaterialDesignIconButton}"
                                                    IsEnabled="{Binding IsSelectedForPayment}"
                                                    Padding="4"
                                                    ToolTip="Preview Payment Details"
                                                    Margin="0,0,4,0">
                                                <materialDesign:PackIcon Kind="Eye" 
                                                                         Width="16" 
                                                                         Height="16"/>
                                            </Button>
                                            <Button Command="{Binding DataContext.ShowGrowerPaymentDetailsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{DynamicResource MaterialDesignIconButton}"
                                                    Padding="4"
                                                    ToolTip="Show Payment Details"
                                                    Margin="0,0,4,0">
                                                <materialDesign:PackIcon Kind="Calculator" 
                                                                         Width="16" 
                                                                         Height="16"/>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </materialDesign:Card>
        </Grid>


        <!-- Status Bar -->
        <materialDesign:ColorZone Grid.Row="5" Style="{StaticResource StatusFooterBarStyle}">
            <Grid Margin="15,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Information" Width="16" Height="16" 
                                           VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="Status: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding StatusMessage}"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Selected: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding SelectedBatchIds.Count}"/>
                    <TextBlock Text=" / " Margin="5,0"/>
                    <TextBlock Text="{Binding AvailableBatches.Count}"/>
                    <TextBlock Text=" batches" Margin="5,0"/>
                </StackPanel>
            </Grid>
        </materialDesign:ColorZone>
    </Grid>
</UserControl>
